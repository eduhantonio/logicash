{% extends 'auth/base_auth.html' %}

{% block title %}Nova Senha - LogiCash{% endblock %}

{% block card_header %}
    <h2><i class="fas fa-key"></i> Nova Senha</h2>
    <p>Digite sua nova senha para {{ user.first_name|default:user.username }}</p>
{% endblock %}

{% block card_body %}
    <form method="post" class="auth-form">
        {% csrf_token %}
        
        <!-- Nova Senha -->
        <div class="form-group">
            <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                <i class="fas fa-lock"></i> {{ form.new_password1.label }}
            </label>
            {{ form.new_password1 }}
            {% if form.new_password1.errors %}
                <div class="form-errors">
                    {% for error in form.new_password1.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- Confirmar Nova Senha -->
        <div class="form-group">
            <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                <i class="fas fa-lock"></i> {{ form.new_password2.label }}
            </label>
            {{ form.new_password2 }}
            {% if form.new_password2.errors %}
                <div class="form-errors">
                    {% for error in form.new_password2.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- Indicador de Força da Senha -->
        <div class="password-strength-container">
            <div class="password-requirements">
                <h6><i class="fas fa-info-circle"></i> Requisitos da senha:</h6>
                <ul>
                    <li id="req-length"><i class="fas fa-times"></i> Pelo menos 8 caracteres</li>
                    <li id="req-lower"><i class="fas fa-times"></i> Uma letra minúscula</li>
                    <li id="req-upper"><i class="fas fa-times"></i> Uma letra maiúscula</li>
                    <li id="req-number"><i class="fas fa-times"></i> Um número</li>
                </ul>
            </div>
        </div>

        <!-- Botão de Submit -->
        <div class="form-group">
            <button type="submit" class="btn btn-primary auth-btn" id="submitBtn" disabled>
                <i class="fas fa-check"></i>
                Redefinir Senha
            </button>
        </div>
    </form>
{% endblock %}

{% block auth_links %}
    <div class="auth-switch">
        <p>Lembrou da sua senha?</p>
        <a href="{% url 'login' %}" class="btn btn-outline-primary">
            <i class="fas fa-sign-in-alt"></i>
            Fazer Login
        </a>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const password1 = document.getElementById('{{ form.new_password1.id_for_label }}');
    const password2 = document.getElementById('{{ form.new_password2.id_for_label }}');
    const submitBtn = document.getElementById('submitBtn');
    
    // Validação em tempo real
    function validatePasswords() {
        const p1 = password1.value;
        const p2 = password2.value;
        
        // Verificar requisitos
        const length = p1.length >= 8;
        const lower = /[a-z]/.test(p1);
        const upper = /[A-Z]/.test(p1);
        const number = /[0-9]/.test(p1);
        const match = p1 === p2 && p1.length > 0;
        
        // Atualizar indicadores visuais
        updateRequirement('req-length', length);
        updateRequirement('req-lower', lower);
        updateRequirement('req-upper', upper);
        updateRequirement('req-number', number);
        
        // Habilitar botão se todos os requisitos forem atendidos
        const allValid = length && lower && upper && number && match;
        submitBtn.disabled = !allValid;
        
        // Validação visual das senhas
        if (p2.length > 0) {
            if (match) {
                password2.style.borderColor = '#198754';
                password2.style.backgroundColor = '#d1e7dd';
            } else {
                password2.style.borderColor = '#dc3545';
                password2.style.backgroundColor = '#f8d7da';
            }
        } else {
            password2.style.borderColor = '';
            password2.style.backgroundColor = '';
        }
    }
    
    function updateRequirement(id, isValid) {
        const element = document.getElementById(id);
        const icon = element.querySelector('i');
        if (isValid) {
            icon.className = 'fas fa-check text-success';
            element.style.color = '#198754';
        } else {
            icon.className = 'fas fa-times text-danger';
            element.style.color = '#dc3545';
        }
    }
    
    password1.addEventListener('input', validatePasswords);
    password2.addEventListener('input', validatePasswords);
    
    // Animação de entrada
    const formGroups = document.querySelectorAll('.form-group');
    formGroups.forEach((group, index) => {
        group.style.opacity = '0';
        group.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            group.style.transition = 'all 0.6s ease-out';
            group.style.opacity = '1';
            group.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Efeito de foco nos inputs
    const inputs = document.querySelectorAll('.auth-input');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });
        
        input.addEventListener('blur', function() {
            if (!this.value) {
                this.parentElement.classList.remove('focused');
            }
        });
    });
});
</script>
{% endblock %}
